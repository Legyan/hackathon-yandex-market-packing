# hackathon-yandex-market-packing

Проект разработан для определения наиболее эффективного способа упаковки товара и предоставления этой информации упаковщику Яндекс Маркета.

Разработан в рамках хакатона командой №10.

[![YM-pack workflow](https://github.com/Legyan/hackathon-yandex-market-packing/actions/workflows/main.yml/badge.svg?branch=main)](https://github.com/Legyan/hackathon-yandex-market-packing/actions/workflows/main.yml)

Развёрнутый проект доступен по адресу http://62.84.121.232.

Swagger документация backend: http://62.84.121.232:8000/docs.

Swagger документация DS: http://62.84.121.232:8001/docs.

### Стек технологий 

![](https://img.shields.io/badge/Python-3.10-black?style=flat&logo=python) 
![](https://img.shields.io/badge/FastAPI-0.96.0-black?style=flat&logo=fastapi)
![](https://img.shields.io/badge/Uvicorn-0.17.0-black?style=flat&logo=uvicorn)
![](https://img.shields.io/badge/Pydantic-1.10.8-black?style=flat)
![](https://img.shields.io/badge/SQLAlchemy-1.4.36-black?style=flat)
![](https://img.shields.io/badge/Pandas-2.0.2-black?style=flat&logo=pandas)
![](https://img.shields.io/badge/Numpy-1.24.3-black?style=flat&logo=numpy)
![](https://img.shields.io/badge/LightGBM-3.3.5-black?style=flat&logo=lightgbm)
![](https://img.shields.io/badge/Typing-3.7.4.3-black?style=flat&logo=typing)
![](https://img.shields.io/badge/React-18.2.0-black?style=flat&logo=react)
![](https://img.shields.io/badge/TypeScript-4.9.5-black?style=flat&logo=typescript)
![](https://img.shields.io/badge/Redux-4.2.1-black?style=flat&logo=redux)
![](https://img.shields.io/badge/Docker-black?style=flat&logo=docker)

<details>
<summary><h2>Запуск проекта</h2></summary>

1. Перейти в директорию /infra:

    ```shell
    cd infra/
    ```

2. Создать в директории файл .env и заполнить его согласно примеру в .env.example:

    ```shell
   nano .env
   ```

   ```
    POSTGRES_DB=ym-packing
    POSTGRES_USER=postgres
    POSTGRES_PASSWORD=postgres
    DB_HOST=db-ym-pack
    DB_PORT=5432
    DATABASE_URL=postgresql+asyncpg://postgres:postgres@db-ym-pack/postgres
    DS_PACK_URL=http://ds-ym-pack:8000/pack
    SECRET_KEY=SECRET_KEY
   ```

3. Запустить все контейнеры приложения с помощью Docker-compose:

    ```shell
    sudo docker-compose up -d --build
    ```

4. Применить миграции к базе данных.

   ```shell
   sudo docker exec infra_backend-ym-pack_1 alembic upgrade head
   ```

5. Заполнить базу данных тестовыми данными:

    ```shell
    sudo docker exec infra_backend-ym-pack_1 python3 -m app.management.fill_db
    ```

6. Сгенерировать штрих-коды товаров и добавить в базу:

    ```shell
    sudo docker exec infra_backend-ym-pack_1 python3 -m app.management.add_random_barcodes
    ```

7. Добавить тестовые заказы:

    ```shell
    sudo docker exec infra_backend-ym-pack_1 python3 -m app.management.add_orders
    ```

Проект будет развернут и доступен по адресу http://localhost.

Swagger документация backend: http://localhost:8000/docs.

Swagger документация DS: http://localhost:8001/docs.

Для обнуления базы данных доступна команда:

```shell
sudo docker exec infra_backend-ym-pack_1 python3 -m app.management.clear_db
```

</details>

<details open>
<summary><h2>Описание работы проекта</h2></summary>

При первом переходе на сайт сервиса, пользователь попадает на страницу регистрации стола. Список доступных для ввода столов приведён в [tables.csv](./backend/data/tables.csv) в столбце name. Введите любой, например `PACK-1`, и нажмите Enter. Пользователь будет авторизован в системе, ему вернётся JWT токен и присвоится выбранный стол.

Далее пользователь попадает на страницу регистрации принтера. Список доступных для ввода принтеров приведён в [printers.csv](./backend/data/printers.csv) в столбце name. Введите любой, например `001`, и нажмите Enter. Пользователю будет присвоен выбранный принтер.

После регистрации принтера пользователь попадает на главную страницу сервиса. Здесь отображается его статистика и есть возможность взять заказ, закрыть стол (logout) и сообщить о проблеме. Нажмите кнопку "Получить заказ". По нажатию кнопки пользователь получает заказ из сохранённых в базе.

*Заказы добавляются в базу с помощью POST запроса на эндпоинт [api/v1/order](http://localhost:8000/docs#/Orders/add_order_api_v1_order_post). Отправляя в запросе список существующих в [базе](./backend/data/products.csv) SKU или взяв готовый JSON заказа из [тестовых заказов](./backend/data/orders.json), вы можете добавить новый заказ в базу. Перед отправлением заказа пользователю, по специальному [эндпоинту](http://localhost:8001/docs#/default/get_prediction_pack_post) для него будут получены и записаны в базу данных рекомендации по упаковке. На момент начала проверки в базе данных уже лежит информация о 5-ти тестовых заказах, добавленных в базу managment командой пункте 7 инструкции по запуску проекта.*

После получения заказа, у пользователя на экране отображаются товары в заказе и несколько рекоммендаций по их упаковке. Переключая рекоммендованные варианты упаковки в правой части экрана, в левой части экрана пользователь может видеть какие товары в какую коробку рекомендовал упаковать алгоритм.

Выбрав одну из рекомендаций, пользователь сканирует или вводит вручную коробку, в которую будет упаковывать товар. Нажмите кнопку "Ввести с клавиатуры", введите название одной из отображенных на экране [упаковок](./backend/data/cartontypes.csv) и нажмите Enter. Выбранная упаковка отобразится на экране.

После открытия коробки, пользователь сканирует или вводит вручную штрих-код товара, sku которого отображён рядом с количеством товара в упаковке. Введите любой штрих-код из [таблицы](./backend/data/barcode_sku.csv)(столбец barcode), значение столбца SKU которого совпадает с SKU одного из товаров в активной коробке, и нажмите Enter. Например для SKU `d9af6ce6f9e303f4b1a8cb47cde21975` можно ввести штрих-код `44333105202301`. После введения штрих-кода с помощью кнопки "Ввести с клавиатуры", его состояние отобразится в интерфейсе пользователя.

После отправки штрих-кода, сервис может потребовать предоставить IMEI и/или маркировку "Честный знак". Их полноценная проверка в проекте не реализуется, для прохождения mock-проверки введите любую 15-символьную строку для IMEI и 13-ти символьную строку для "Честного знака".

После заполнения упаковки пользователь её закрывает и печатает для неё штрих-код. Нажмите на кнопку "Закрыть коробку" рядом с иконкой заполненной коробки. В правом верхнем углу отобразится окно с предложением распечатать штрих-код, нажмите "Печатать". Закрытие коробки отобразится на экране.

При несоответсвии действий пользователя выбранной рекомендации, пользователь будет переключен в режим супергероя.В этом режиме рекомендации не отображаются, но действия пользователя также отображаются на экране и записываются в базу данных. 

Если пользователю будет необходимо убрать уже отсканированный товар из коробки, он может это сделать с помощью кнопки "Изменить состав коробки". Рядом с товарами в коробке отобразятся красные "крестики" по нажатию которых можно будет выбрать несколько товаров для удаления. После того как все товары для удаления отмечены, пользователь нажимает кнопку "Готово", и товары "вываливаются" из коробки, переставая считаться отсканированными. Они отображаются под упаковками в левой части экрана и могут быть помещены в другую упаковку.

Если во время упаковки заказа у пользователя возникла проблема, он может сообщить о ней нажав на кнопку "Есть проблема". Нажмите на эту кнопку, на экране отобразятся кнопки с возможными проблемами, нажав на которые, пользователь может сообщить об отсутствии товара, бракованном товаре в заказе или вызвать на помощь бригадира при более сложной проблеме.

После того, как пользователь упаковал все товары в заказе и закрыл все упаковки, он нажимает на кнопку "Упаковано". Если все товары из заказа действительно были упакованы, он попадает на экран "Хорошая работа" с кнопкой "Готово". По нажатию на эту кнопку, пользователь попадает на экран получения нового заказа для упаковки со своей обновлённой статистикой сборки заказов.

Далее пользователь может получить новый заказ, или закончить работу. Для завершения работы пользователь нажимет на кнопку "Закрыть стол" на экране получения нового заказа, от него отвязывается занятый им стол и принтер и сервис возвращется на стартовую страницу регистрации стола.

</details>

<details open>
<summary><h2>Описание алгоритма выбора упаковки заказа</h2></summary>

Для того, чтобы покупатель получил заказ, перед отправкой заказанные товары упаковывают в посылки. Компания заметила, что сотрудник тратит большое количество времени на выбор упаковочного материала, в который необходимо упаковать товары. Существует большое количество упаковочного материала (коробки, пакеты, пленка). Необходимо было придумать и реализовать способ подсказывать пользователю информацию о выборе упаковочного материала.

### Цели нашего проекта:

- с высокой точностью рекомендовать правильную упаковку для заказа, которая позволит доставить товары без порчи клиенту и минимизирует затраты на упаковочный материал;
- отображение статистики о работе модели;
- интерфейс о том, как советовать информацию по выбору коробки
пользователю.

### Данные

В нашем распоряжении историческая информация о заказанных товарах и упаковке, представленая в $6$ таблицах.
По количеству товаров в составе заказы распределены не равномерно, $65$ % из них с одним товаром. $97$ % заказов включает в себя не более $5$ товаров.

![orders 2](https://github.com/Legyan/hackathon-yandex-market-packing/assets/93463677/e61e3988-065a-452a-b09e-a224b8844a98)

Практически все заказы помещаются в одну упаковку (без учета товаров, не требующих упаковки или упакованных в пленку).

![one_pack_share 2](https://github.com/Legyan/hackathon-yandex-market-packing/assets/93463677/e6cc0c9d-a641-47b9-8e7a-ea9acbe11fb8)

Покрытие потребности заказчика при предсказании упаковки для заказов, включающих не более $5$ товаров, составляет $93.79$ %.

![output 2](https://github.com/Legyan/hackathon-yandex-market-packing/assets/93463677/fae867ef-5df4-4d1a-aeeb-422fa7dce390)


### Алгоритм
Предсказание упаковки можно разделить на $3$ основные части:
1. Выделение товаров не требующих упаковки или упаковываемых в пленку на основе карготипов $340$ и $360$;
2. Подбор упаковки для одного товара на основе накопленной статистики и с помощью сравнения габаритов товара с габаритами имеющихся упаковок. Предлагается самая дешевая из подошедших упаковок и, по возможности, еще 1-2 альтернативы.
   
 ![image_2023-06-16_10-16-41 2](https://github.com/Legyan/hackathon-yandex-market-packing/assets/93463677/7159c959-d43c-4cce-a632-5d9d7c5b9e50)

3. ML-подход для заказов с 2-5 товарами. Предлагается $3$ самые вероятные по мнению модели варианта упаковки.

### Результаты
Для $76.7$ % заказов алгоритм предсказывает подходящую и оптимальную по цене упаковку.
Экономия на упаковке составила $209$ $771.49$ руб. или $9.56$ %. Если считать, что в нашем распоряжении были данные за один день и распределение заказов в среднем соответствует датасету, то за год экономия может составить $76.5$ млн. руб.

![image_2023-06-17_23-28-28 2](https://github.com/Legyan/hackathon-yandex-market-packing/assets/93463677/ebab494b-3f2e-4b71-9ae3-ff966c874993)

</details>




<details>
<summary><h2>ToDo</h2></summary>

### Backend

1. Добавить очередь задачь для получения рекомендаций от контейнера DS.

2. Доделать проверку штрих-кода на то, что товар с sku этого штрих-кода уже был пробит необходимое для этого заказа количество раз.

3. Реализовать хранение и обновление статистики работы пользователя для подсчёта и вывода KPI.

</details>

## Команда

*Project manager*

- [Максим Евдокимов]() 

*Design*

- [Евгения Швецова]()

- [Ксения Забровская]()

*Data Science*

- [Татьяна Кубарь](https://github.com/TaniaKubar)

- [Дмитрий Лялин]()

- [Иван Марков]()

*Frontend*

- [Алексей Шайдуллин](https://github.com/AlekseyShaydullin)

- [Владислав Никитин](https://github.com/BeRealDude)

*Backend*

- [Левон Гегамян](https://github.com/Legyan)

- [Никита Макарьев](https://github.com/NikitaMackariev)
